<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Ficha - Sistema Youkai</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
<header>
    <nav class="future-tabs">
        <a class="tab-button" href="../index.html">XP Avulso</a>
        <a class="tab-button active" href="char.html">Personagem</a>
        <a class="tab-button" href="#">Profissões</a>
    </nav>
</header>

<main>
    <div class="container">
        <h2>Ficha de Personagem</h2>

        <div class="status-card">
            <h3>1. Identidade</h3>
            <div class="input-group">
                <label>Nome do Personagem</label>
                <input type="text" id="charName" placeholder="Ex: Akuma-kun">
            </div>
            <div class="grid-ranks">
                <div class="input-group">
                    <label>Raça</label>
                    <select id="charRace"></select> </div>
                <div class="input-group">
                    <label>Classe</label>
                    <select id="charClass"></select> </div>
            </div>
            <div class="grid-ranks">
                <div class="input-group">
                    <label>Nível Personagem</label>
                    <input type="number" id="charLevel" value="1">
                </div>
                <div class="input-group">
                    <label>Nível Classe</label>
                    <input type="number" id="classLevel" value="1">
                </div>
            </div>
        </div>

        <div class="status-card" id="card-habilidades" style="border-left-color: var(--primary);">
            <h3>2. Habilidades de Classe</h3>
            <div id="habilidades-opcoes" class="grid-ranks" style="grid-template-columns: 1fr 1fr;"></div>
        </div>

        <h3>3. Atributos</h3>
        <div class="status-card" style="border-left-color: var(--primary);">
            <div class="grid-ranks">
                <div class="input-group">
                    <label>Vida Atual</label>
                    <div class="fixed-val" id="hpAtual">0</div>
                </div>
                <div class="input-group">
                    <label>Sanidade</label>
                    <div class="fixed-val" id="sanidade">0</div>
                </div>
            </div>
            <div class="grid-ranks">
                <div class="input-group"><label>FOR</label><input type="number" id="stat_for"></div>
                <div class="input-group"><label>DES</label><input type="number" id="stat_des"></div>
            </div>
            <div class="grid-ranks">
                <div class="input-group"><label>RM</label><input type="number" id="stat_rm"></div>
                <div class="input-group"><label>RF</label><input type="number" id="stat_rf"></div>
            </div>
            <div class="grid-ranks">
                <div class="input-group"><label>NM</label><input type="number" id="stat_nm"></div>
                <div class="input-group"><label>RC</label><input type="number" id="stat_rc"></div>
            </div>
            <div class="grid-ranks">
                <div class="input-group">
                    <label>Regen</label>
                    <input type="number" id="stat_regen">
                </label>
                </div>
            </div>
        </div>

        <h3>4. Resumo e Passivas</h3>
        <textarea id="habilidades" placeholder="Passivas automáticas aparecerão aqui..."></textarea>

        <button class="btn-calc" onclick="document.getElementById('importFile').click()">Importar .txt</button>
        <input type="file" id="importFile" style="display:none" accept=".txt">
        <button class="btn-export" onclick="exportarTxt()">Exportar Ficha</button>
    </div>
</main>

<script>
const db = {
    racas: {
        "Humano": { hp: 100,
                    san: 100,

                    // Status Físicos
                    for: 2,
                    rm: 1,
                    rf: 1,
                    des: 1,
                    regen: 0,

                    // Status Mágicos
                    nm: 5,
                    rc: 3,
                    passiva:
                    " - Passiva: [Smart Lecture] - Pode aprender magia através de grimórios e ensinamentos de outras pessoas. \n"+
                    "\n - Passiva: [Emotional Trigger] - Em situações de perigo (inclui combate direto e quando consegue perceber ataques furtivos), sua destreza aumenta em +3(+nível do personagem X 1.2) instantaneamente."
        },
        "Elfo": { hp: 120,
                san: 100,

                // Status Físicos
                for: 3,
                rm: 3,
                rf: 2,
                des: 1,
                regen: 0,

                // Status Mágicos
                nm: 1,
                rc: 0,
                passiva:
                "- Passiva: [Forest Friendly] - Consegue se comunicar com animais e plantas. \n"+
                "\n - Passiva: [Visão Mágica] - Permite ver inimigos atrás de objetos em até 2km de distância. \n"+
                "\n - Linguagem: Sabem a língua humana e élfica."
        },
        "Vastaya": { hp:90,
                    san: 110,

                    // Status Físicos
                    for: 2,
                    rm: 1,
                    rf: 1,
                    des: 4,
                    regen: 2,

                    // Status Mágicos
                    nm: 1,
                    rc: 0,
                    passiva:
                    "- Digite as passivas manualmente \n"
        },
        "Draconiano": { hp:190,
                    san: 85,

                    // Status Físicos
                    for: 4,
                    rm: 2,
                    rf: 2,
                    des: 1,
                    regen: 0,

                    // Status Mágicos
                    nm: 0,
                    rc: 0,
                    passiva:
                    "- Ativa: [Fúria do Dragão] - Seu próximo ataque direto causa o dobro de dano (Cooldown de 3 turnos). \n"+
                    "\n - Passiva: [Vontade Dracônica] - Quando o Daconiano estiver lutando sozinho, recebe: \n +3 de FOR (+nível do personagem) \n +5 de RM (+nível do personagem)\n +5 de RF(+nível do personagem)\n"
        },
        "Fada": { 
                    hp: 40,
                    san: 200,

                    // Status Físicos
                    for: 0,
                    rm: 0,
                    rf: 0,
                    des: 10,
                    regen: 0,

                    // Status Mágicos
                    nm: 3,
                    rc: 2,
                    passiva:
                    "- Passiva: [Flight] - Permite o vôo por tempo indeterminado em alturas não específicas (a fada só não pode sair do planeta).\n"+
                    "\n - Passiva: [Fairy's Dust] - Enquanto estiver voando, emite um pó com propriedades curativas (cura 1% da vida máxima por turno ou 5% por minuto fora de combate, aplicável em si mesmo).\n"
        },
        "Youkai": { 
                    hp: 150,
                    san: 60,

                    // Status Físicos
                    for: 4,
                    rm: 1,
                    rf: 1,
                    des: 4,
                    regen: 0,

                    // Status Mágicos
                    nm: 0,
                    rc: 0,
                    passiva:
                    "- Passiva: [Demon Sanity] - Quando a sanidade abaixar em menos de 50 pontos, você se torna exaltado, ganhando:\n+2 de FOR (+nível do personagem);\n+5 de RM (+nível do personagem);\n+ 5 de RC (+nível do personagem);\n"+
                    "\n - Passiva: [Demon Fury] - Enquanto em batalha, caso não desfira golpes, regenera +2(+ nível do personagem) de vida por turno;  \n"
        },

        "Meio Deus": { 
                    hp: 55,
                    san: 200,

                    // Status Físicos
                    for: 4,
                    rm: 4,
                    rf: 4,
                    des: 4,
                    regen: 2,

                    // Status Mágicos
                    nm: 2,
                    rc: 2,
                    passiva:
                    "- Passiva: [Divine Memory] - Só pode usar o elemento [Celestial] em magias.\n"+
                    "\n - Passiva: [Divine Essence] - Toda arma que você tocar será restaurada (concertada) e desferirá +10 de dano(+nível do personagem).\n"+
                    "\n - Passiva: [Divine Body] - É imune a qualquer tipo de maldição."
        },
        "Meio Demônio": { 
                    hp: 200,
                    san: 55,

                    // Status Físicos
                    for: 4,
                    rm: 4,
                    rf: 4,
                    des: 4,
                    regen: 2,

                    // Status Mágicos
                    nm: 2,
                    rc: 2,
                    passiva:
                    "- Passiva: [Demon Memory] - Só pode usar o elemento [Arcano] em magias.\n"+
                    "\n - Passiva: [Demon Essence] - Todo golpe recebido, será dissipado 1d15 de dano (+nível do personagem).\n"+
                    "\n - Passiva: [Demon Body] - É imune a qualquer tipo de maldição. "
        },
        "Morto Vivo": { 
                    hp: 70,
                    san: 51,

                    // Status Físicos
                    for: 7,
                    rm: 2,
                    rf: 2,
                    des: 0,
                    regen: 10,

                    // Status Mágicos
                    nm: 0,
                    rc: 0,
                    passiva:
                    "- Passiva: [Meat Life Gain] - Ao consumir carne de outros seres vivos, regenera vida em +120 por corpo.\n"+
                    "\n - Passiva: [Meat Stats Gain] - Ao consumir um corpo, você ganha +5 em FOR, RM, RF e DES permanentemente, mas você não recebe pontos de nenhum outro método.\n"+
                    "\n - Maldição: [Withedered Revive] - Caso seja revivido, todo status a mais adquirido será reduzido em 20% (arredonde números quebrados para cima)"
        },
        "Tritão": { 
                    hp: 120,
                    san: 90,

                    // Status Físicos
                    for: 1,
                    rm: 1,
                    rf: 1,
                    des: 2,
                    regen: 0,

                    // Status Mágicos
                    nm: 5,
                    rc: 0,
                    passiva:
                    "- Passiva: [Fishy Body] - Podem assumir uma forma semelhante a de um peixe, criando barbatanas e uma cauda de peixe, respirando de baixo d'água.\n"+
                    "\n - Passiva: [Squishy Fishy] - Enquanto na água, ganham +7 de DES e FOR (+nível do personagem X 1.2). \n"
        },

    },
    classes: {
        "Guerreiro": [
            "Força Ascendente", 
            "Resistência Ascendente", 
            "Corpo Condutor", 
            "Corpo Forte", 
            "Golpe Estridente", 
            "Corpo Mais Forte", 
            "Ativa: Combatente Experiente", 
            "Body Builder", 
            "Ampliação Furiosa", 
            "Ampliação Maníaca"
        ],
        "Mago": [
            "Restoration Grantee", 
            "No Stick Needed", 
            "Elemental Knowledge", 
            "Shield Adiction", 
            "Perfect Aim", 
            "Magic Mirror", 
            "Arch Mage", 
            "Arch Healer", 
            "The World Beyond", 
            "The Magic Beyond"
        ],
        
        "Feiticeiro": [
            "Dark Change", 
            "Light Change", 
            "Dark Control", 
            "Mind Control", 
            "Witch Experience", 
            "Dark Influence", 
            "Necromancer", 
            "Dark Mage", 
            "Litch", 
            "Arch Dark Mage"
        ],

        "Arqueiro": [
            "Arrow Mutation", 
            "Fleetching Expertise", 
            "Critical Deley", 
            "Argon Scope", 
            "Metal Auger", 
            "Shock Arrow", 
            "Invisible Sniper", 
            "Smite Alive", 
            "Arrow of Dammed", 
            "True Arrow"
        ],

        "Ladino": [
            "Instinto Assassino", 
            "Destreza Crescente", 
            "Sangramento Feroz", 
            "Envenenamento Feroz", 
            "Capa da Morte", 
            "Piedade da Morte", 
            "Presença Avassaladora", 
            "Ladrão de Vidas", 
            "Anjo da Morte", 
            "Fantasma Sangrento"
        ],
        "Clérigo": [
            "Self Buffering", 
            "Other Debuffering", 
            "Undead Bounty", 
            "Strength Elevation", 
            "Purification Variable", 
            "Degradation Variable", 
            "Ponto de Ruptura", 
            "Vida ou Morte", 
            "Legends Never Die", 
            "The Devil Will Not Win..."
        ],
    }
};
// Inicializar Seletores
function init() {
    const rSel = document.getElementById('charRace');
    const cSel = document.getElementById('charClass');
    const importInput = document.getElementById('importFile');
    
    // Popular selects com os dados do DB
    Object.keys(db.racas).forEach(r => rSel.add(new Option(r, r)));
    Object.keys(db.classes).forEach(c => cSel.add(new Option(c, c)));

    // Eventos de Mudança
    rSel.addEventListener('change', carregarStatusBase);
    cSel.addEventListener('change', renderHabilidades);
    importInput.addEventListener('change', importarTxt);
    
    // Ouvinte global para qualquer input que deva atualizar o resumo textual
    document.querySelectorAll('select, input, textarea').forEach(el => {
        el.addEventListener('change', atualizarTextoFinal);
    });

    // Inicialização do estado da página
    carregarStatusBase();
}

function carregarStatusBase() {
    const raca = db.racas[document.getElementById('charRace').value];
    
    // Atualiza os valores visuais (labels e inputs)
    document.getElementById('hpAtual').innerText = raca.hp;
    document.getElementById('sanidade').innerText = raca.san;
    document.getElementById('stat_for').value = raca.for;
    document.getElementById('stat_des').value = raca.des;
    document.getElementById('stat_rm').value = raca.rm;
    document.getElementById('stat_rf').value = raca.rf;
    document.getElementById('stat_nm').value = raca.nm;
    document.getElementById('stat_rc').value = raca.rc;
    document.getElementById('stat_regen').value = raca.regen;
    
    renderHabilidades();
}

function renderHabilidades() {
    const classe = document.getElementById('charClass').value;
    const container = document.getElementById('habilidades-opcoes');
    container.innerHTML = "";

    db.classes[classe].forEach(hab => {
        const div = document.createElement('div');
        div.className = 'class-check';
        div.innerHTML = `<input type="checkbox" class="hab-check" value="${hab}"> ${hab}`;
        div.querySelector('input').addEventListener('change', atualizarTextoFinal);
        container.appendChild(div);
    });
    atualizarTextoFinal();
}

function atualizarTextoFinal() {
    const racaNome = document.getElementById('charRace').value;
    const classeNome = document.getElementById('charClass').value;
    const nChar = document.getElementById('charLevel').value;
    const nClasse = document.getElementById('classLevel').value;
    const selecionadas = Array.from(document.querySelectorAll('.hab-check:checked')).map(c => c.value);

    let resumo = `--- FICHA TÉCNICA (Nível ${nChar}) ---\n`;
    resumo += `Raça: ${racaNome}\n`;
    resumo += `Passivas de Raça:\n${db.racas[racaNome].passiva}\n\n`;
    resumo += `--- HABILIDADES DE CLASSE (${classeNome} Nível ${nClasse}) ---\n`;
    resumo += selecionadas.length ? selecionadas.join('\n') : "Nenhuma habilidade selecionada.";
    
    document.getElementById('habilidades').value = resumo;
}

function exportarTxt() {
    const nome = document.getElementById('charName').value || "Ficha_Sem_Nome";
    
    // Criamos um formato de "Dicionário" (Chave: Valor) para facilitar a importação depois
    let txt = `[DADOS DO PERSONAGEM]\n`;
    txt += `Nome: ${nome}\n`;
    txt += `Raça: ${document.getElementById('charRace').value}\n`;
    txt += `Classe: ${document.getElementById('charClass').value}\n`;
    txt += `Nível_Personagem: ${document.getElementById('charLevel').value}\n`;
    txt += `Nível_Classe: ${document.getElementById('classLevel').value}\n`;
    txt += `FOR: ${document.getElementById('stat_for').value}\n`;
    txt += `DES: ${document.getElementById('stat_des').value}\n`;
    txt += `RM: ${document.getElementById('stat_rm').value}\n`;
    txt += `RF: ${document.getElementById('stat_rf').value}\n`;
    txt += `NM: ${document.getElementById('stat_nm').value}\n`;
    txt += `RC: ${document.getElementById('stat_rc').value}\n`;
    txt += `Regen: ${document.getElementById('stat_regen').value}\n`;
    txt += `\n[RESUMO E NOTAS]\n`;
    txt += document.getElementById('habilidades').value;

    const blob = new Blob([txt], {type: 'text/plain'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = nome.replace(/\s/g, '_') + ".txt";
    a.click();
}

function importarTxt(event) {
    const arquivo = event.target.files[0];
    if (!arquivo) return;

    const leitor = new FileReader();
    leitor.onload = function(e) {
        const conteudo = e.target.result;
        const linhas = conteudo.split('\n');
        const dados = {};

        // Mapeia o arquivo linha por linha
        linhas.forEach(linha => {
            if (linha.includes(':')) {
                const [chave, valor] = linha.split(':');
                dados[chave.trim()] = valor.trim();
            }
        });

        // Aplica os valores nos campos do HTML
        if (dados['Nome']) document.getElementById('charName').value = dados['Nome'];
        if (dados['Nível_Personagem']) document.getElementById('charLevel').value = dados['Nível_Personagem'];
        if (dados['Nível_Classe']) document.getElementById('classLevel').value = dados['Nível_Classe'];
        
        // Seleciona Raça e Classe primeiro (pois elas resetam os campos)
        if (dados['Raça']) {
            document.getElementById('charRace').value = dados['Raça'];
            carregarStatusBase(); 
        }
        if (dados['Classe']) {
            document.getElementById('charClass').value = dados['Classe'];
            renderHabilidades();
        }

        // Sobrescreve os status com os valores do arquivo (os valores que o jogador upou)
        if (dados['FOR']) document.getElementById('stat_for').value = dados['FOR'];
        if (dados['DES']) document.getElementById('stat_des').value = dados['DES'];
        if (dados['RM']) document.getElementById('stat_rm').value = dados['RM'];
        if (dados['RF']) document.getElementById('stat_rf').value = dados['RF'];
        if (dados['NM']) document.getElementById('stat_nm').value = dados['NM'];
        if (dados['RC']) document.getElementById('stat_rc').value = dados['RC'];
        if (dados['Regen']) document.getElementById('stat_regen').value = dados['Regen'];

        // Recupera o texto de habilidades/notas
        const indexNotas = conteudo.indexOf('[RESUMO E NOTAS]');
        if (indexNotas !== -1) {
            document.getElementById('habilidades').value = conteudo.substring(indexNotas + 17).trim();
        }

        alert("Ficha carregada com sucesso!");
    };
    leitor.readAsText(arquivo);
}

window.onload = init;
</script>

</body>
</html>